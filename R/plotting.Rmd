---
title: "Plotting"
output:
  html_document:
    toc: true
    toc_depth: 3
    toc_float: true
    
knit: (function(input_file, encoding) {
  out_dir <- '../docs';
  rmarkdown::render(input_file,
 encoding=encoding,
 output_file=file.path(dirname(input_file), out_dir, 'plotting.html'))})
---

```{r setup, include=FALSE, message=FALSE}
library(knitr)
library(DT)
library(dplyr)
library(plyr)
knitr::opts_chunk$set(echo = TRUE)
```

Her viser jeg hvordan vi aggreggerer indikatorverdiene til en verdi for økologisk tilstandsverdi og plotter denne. Det meste er scriptet er skrevet av Somon Jacobsson.

```{r}
# Number of simulations
nsim <- 10000

# Short names for ecosystem characteristics
characteristics <- c("ppr", "isf", "bmb", "fgw", "bio", "lsp", "abf")
```


# Step 1: 
indicators, characteristics, years and period summaries

Specify reporting year key to periods
```{r}
periods <- data.frame(period = c(1,1,1,1,1,1,1,1,
                        2,2,2,2,2,
                        3,3,3,3,3,
                        4,4,4,4,4,
                        5,5,5,5,5,
                        6,6,6,6,6), 
                      year = c(1988, 1989, 1990, 1991, 1992, 1993, 1994, 1995, 
                        1996, 1997, 1998, 1999, 2000, 
                        2001, 2002, 2003, 2004, 2005, 
                        2006, 2007, 2008, 2009, 2010, 
                        2011, 2012, 2013, 2014, 2015, 
                        2016, 2017, 2018, 2019, 2020))
```

Save periods file
```{r}

write.csv(periods, "../output/periods.csv")
```

# Step 2: 
load and adjust indicator data

List files with bootstrapped indicator values
```{r}
list.files(path = "../output/indicator_values/",
           pattern=".csv")
```
## Load and adjust data headings etc. 
manual steps required due to different data structures

### Breareal
```{r}
breareal <- read.csv("../output/indicator_values/breareal.csv", header=T)

breareal$period <- 
  periods$period[match(breareal$year, periods$year)]

breareal$X <- "breareal"

```

### Fjellindeks
```{r}
fjellindeks <- read.csv("../output/indicator_values/fjellindeks.csv", header=T)

fjellindeks$period <- 
  periods$period[match(fjellindeks$year, periods$year)]

fjellindeks$X <- "fjellindeks"
```

### Fjellrev
```{r}
fjellrev <- read.csv("../output/indicator_values/fjellrev.csv", header=T)

fjellrev$period <- 
  periods$period[match(fjellrev$year, periods$year)]

fjellrev$X <- "fjellrev"
table(fjellrev$reg, fjellrev$period)
```


### INON
[INON](inon.html) har ingen usikkerhet knyttet til seg. 
```{r}
inon <- read.csv("../output/indicator_values/inon.csv", header=T)
inon$X <- "INON"
inon$period <- periods$period[match(inon$year, periods$year)]
```

### Jerv
```{r}
jerv <- read.csv("../output/indicator_values/jerv.csv", header=T)

jerv$X <- "jerv"
jerv$period <- 
  periods$period[match(jerv$year, periods$year)]
table(jerv$reg, jerv$period)
```

### Kongeørn
```{r}
kongeorn <- read.csv("../output/indicator_values/kongeorn.csv", header=T)

kongeorn$period <- 
  periods$period[match(kongeorn$year, periods$year)]

kongeorn$X <- "kongeørn"
```

### Smågnagere
```{r}
smaagnagere <- read.csv("../output/indicator_values/smågnagere.csv", header=T)
smaagnagere$X <-  "smaagnagere"
smaagnagere$period <- 
  periods$period[match(smaagnagere$year, periods$year)]
table(smaagnagere$reg, smaagnagere$period)
```

### Vinterregn
```{r}
vinterregn <- read.csv("../output/indicator_values/vinterregn.csv", header=T)

vinterregn$X <- "vinterregn"

vinterregn$period <- 
  periods$period[match(vinterregn$year, periods$year)]

table(vinterregn$reg, vinterregn$period)

vinterregn$reg <- plyr::revalue(vinterregn$reg,
      c("Midt-Norge"="C", 
        "Nord-Norge"="N",
        "Norge" ="Norge",
        "Østlandet"="E",
        "Sørlandet"="S",
        "Vestlandet"="W"))

```

# Step 3: Combine datasets

Starting with fjellindeks
```{r}
allind <- fjellindeks
```

I'm just going to do this for the last period and not bother with the time series
```{r}
allind <- allind[allind$period==6,]
```

```{r}
# Periods to use
periods_use <- unlist(unique(allind$period))
```
Subset additional data
```{r}
fjellrev <- fjellrev[fjellrev$period%in%periods_use,]
inon     <- inon[inon$period%in%periods_use,]
jerv     <- jerv[jerv$period%in%periods_use,]
smaagnagere <- smaagnagere[smaagnagere$period%in%periods_use,]
vinterregn <- vinterregn[vinterregn$period%in%periods_use,]

kongeorn <- kongeorn[kongeorn$period%in%periods_use,]

breareal <- breareal[breareal$period%in%periods_use,]
```

## Order data

```{r}
regOrder = c("C","N","W", "S", "E","Norge")
#perOrder = c(2,4,5,6) # not relevant
```

```{r}
fjellindeks <- fjellindeks %>%
  arrange(match(reg, regOrder), desc(period))

breareal <- breareal %>%
  arrange(match(reg, regOrder), desc(period))

kongeorn <- kongeorn %>%
  arrange(match(reg, regOrder), desc(period))


fjellrev <- fjellrev %>%
  arrange(match(reg, regOrder), desc(period))

inon <- inon %>%
  arrange(match(reg, regOrder), desc(period))

jerv <- jerv %>%
  arrange(match(reg, regOrder), desc(period))

smaagnagere <- smaagnagere %>%
  arrange(match(reg, regOrder), desc(period))

vinterregn <- vinterregn %>%
  arrange(match(reg, regOrder), desc(period))

```

## Add additional data to allind data
```{r}
allind <- rbind(allind, 
                 fjellrev,
                 inon,
                 jerv,
                 smaagnagere,
                 vinterregn,
                kongeorn,
                breareal)
table(allind$X)
```

The number of re-samplings differs.

## Save allind file
```{r}
write.csv(allind, "../output/allind_temp.csv")
```

Here Simon added reduced weighting to indiactors with both high and low scaling methods. I will do this only if neccessary.

# Step 4: Fill indicator <-> characteristics matrix

Empty indicator <-> character matrix 
```{r}
# Specify total number of indicators (incl. double counting of two-sided)
nind <- 8 

ind_char <- data.frame(matrix(nrow=nind, ncol=8))
names(ind_char) <- c("IND", characteristics)
```

Start filling indicator <-> characteristic matrix
```{r}
ind_char$IND <- unique(allind$X)
```

```{r}
# Primary productivity
ind_char$ppr <- ifelse(
  ind_char$IND=="ndvi",
                       1,0)

# Biomass distribution among trophic levels 
ind_char$bmb <- ifelse(
  ind_char$IND=="ndvi"|
  ind_char$IND=="fjellrev"|
  ind_char$IND=="jerv"|
  ind_char$IND=="smaagnagere"|
  ind_char$IND=="lirype"|
  ind_char$IND=="lirype"|
  ind_char$IND=="fjellrype"|
  ind_char$IND=="kongeørn"|
  ind_char$IND=="fjellvaak"
    ,
                       1,0)

# Functional groups within trophic levels
ind_char$fgw <- ifelse(
  ind_char$IND=="fjellrev"|
  ind_char$IND=="jerv"|
  ind_char$IND=="smaagnagere"|
  ind_char$IND=="lirype"|
  ind_char$IND=="lirype"|
  ind_char$IND=="fjellrype"|
  ind_char$IND=="kongeørn"|
  ind_char$IND=="fjellvaak"
    ,
                       1,0)

# Structurally important species and biophysical structures
ind_char$isf <- ifelse(
  ind_char$IND=="smaagnagere"
    ,
                       1,0)

# Biodiversity
ind_char$bio <- ifelse(
  ind_char$IND=="fjellindeks"
    ,
                       1,0)

# Landscape ecological patterns
ind_char$lsp <- ifelse(
  ind_char$IND=="INON"|
  ind_char$IND=="fragmentering"  
    ,
                       1,0)

# Abiotic factors
ind_char$abf <- ifelse(
  ind_char$IND=="ellenbergN"|
  ind_char$IND=="ellenbergL"|
  ind_char$IND=="breareal"|
  ind_char$IND=="snømengde"|
  ind_char$IND=="snøvarighet"|
  ind_char$IND=="vinterregn"
    ,
                       1,0)

```

Write indicator-characteristic matrix
```{r}
write.csv(ind_char, "../output/ind_char.csv")
```


# Step 5: Indicator quantiles per region and period

```{r}
#unique(allind$X[allind$reg=="Sørlandet"])

periods <- unlist(unique(allind$period))
regions <- unlist(unique(allind$reg))
all_Q <- data.frame()
per_reg <- length(periods)*length(regions)
```

```{r}
for (i in 4:ncol(allind)) {
  temp_ind <- allind[,c(1:3,i)]
  
  for (j in 1:length(periods)){
    
    temp_ind2 <- subset(temp_ind, a_period==periods[j])
    
    for (k in 1:length(regions)){
      
      # Subset region, and delete reg/per columns
      temp_ind3 <- subset(temp_ind2, a_reg==regions[k])
      
      ind <- names(temp_ind3)[4]
      reg <- regions[k]
      per <- periods[j]
      
      if(ind=="deer_scaled"){ 
        
        (if(mean(temp_ind3[,4])>1){
          
          temp_ind3[,4] <- (2-temp_ind3[,4])
          temp_ind3[,4][temp_ind3[,4]<0] <- 0
          
          ind <- "deer_scaled_upper"
          
        } else {
          temp_ind3[,4] <- temp_ind3[,4]
          ind <- "deer_scaled_lower"
        })
      } else {
        
        NULL
        
      }
      
      temp_Q <- tryCatch(quantile(temp_ind3[,4],c(0.025, 0.5, 0.975)), error=function(e){})
      all_Q <- rbind(all_Q, data.frame(ind, reg, per, 
                                       ifelse(is.null(temp_Q), NA, temp_Q[1]),
                                       ifelse(is.null(temp_Q), NA, temp_Q[2]),
                                       ifelse(is.null(temp_Q), NA, temp_Q[3]))) 
    }
  }
}

names(all_Q) <- c("ind", "reg", "per", "low", "med", "upp")

```

