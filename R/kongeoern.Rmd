---
title: "Kongeørn"
output:
  html_document:
    toc: true
    toc_depth: 3
    toc_float: true
    
knit: (function(input_file, encoding) {
  out_dir <- '../docs';
  rmarkdown::render(input_file,
 encoding=encoding,
 output_file=file.path(dirname(input_file), out_dir, 'kongeoern.html'))})
---

```{r setup, include=FALSE, message=FALSE}
library(knitr)
library(sf)
library(raster) # burde kanskje byttes ut med stars
library(sp)  # usikker på om jeg trenger denne
library(rgdal)
library(tmap)
library(mapview)
# library(stars)
knitr::opts_chunk$set(echo = TRUE)
```


## Analyser av kongeørnterritorier
Datasettet ligger på P:// som er en server på NINA.


```{r import}

#dat <- sf::st_read('P:/41201042_okologisk_tilstand_fastlandsnorge_2020_dataanaly/fjell2021/data/utbredelseKongeoern/Buff_10_All_terr_kongeørn.shp')

#dat <- sf::st_read('C:/Users/anders.kolstad/Documents/Github/IBECA_NINA/data/utbredelseKongeoern/Buff_10_All_terr_kongeørn.shp')

# Denne funker for rstudio server. Den over funker på lokal maskin.
dat <- sf::st_read('/data/P-Prosjekter/41201042_okologisk_tilstand_fastlandsnorge_2020_dataanaly/fjell2021/data/utbredelseKongeoern/Buff_10_All_terr_kongeørn.shp')


head(dat)
```

Datasettet inneholder alle kjente kongeørnterritorier i Norge (vi bryr oss ikke om streiffugler). 

Laster inn en outline for Norge.

```{r crs}
crs(dat)
```


## Outline of Norway
```{r outline, eval=FALSE}
nor <- raster::getData('GADM', country='NOR', level=0)%>%
  sp::spTransform("+proj=utm +zone=33")
saveRDS(nor, '../data/norway_outline.RDS')
```

```{r, echo=FALSE}
nor <- readRDS('../data/norway_outline.RDS')
```

Henter shp med regionene

```{r import regions}
reg <- st_read("../data/regioner_2010/regNorway_wgs84 - MERGED.shp")%>%
  st_transform(crs = crs(dat))
```

Fikser øæå
```{r}
reg$region[reg$region=="Ã\u0098stlandet"] <- "Østlandet"
reg$region[reg$region=="SÃ¸rlandet"] <- "Sørlandet"

```


Klipper regionene etter norgeskartet
```{r, message=FALSE}
reg_clipped <- st_intersection(reg, st_as_sf(nor))
```


```{r}
tmap_mode("view")
tm_shape(dat) + 
    tm_polygons(border.col = "grey", 
                col = 'Visited_20',
                title = "Overvåket i 2015-2019?",
                style = "cat",
                drop.levels = T)+
  tm_shape(nor)+
    tm_polygons(alpha = 0,
                border.col = "black")+
  tm_shape(reg_clipped)+
    tm_polygons(alpha = 0,
                border.col = "black")+
  tm_text("region", size=1.5)+
  tm_layout(title = "Alle kjente norske\nkongeørnterritorier")
  

```



```{r}
length(unique(dat$Terr_total))
```
Det er 1371 kjente territorier i Norge i dag.

Er det noen duplikater?
```{r}
nrow(dat)
```
Nei, det er det ikke.


Ikke alle territorier er okkupert til en hver tid. Det er to kolonner (`Visit_2021` og `Visit_20`) som indikarer hvorvidt territoriene har blitt overvåket i hhv 2010-2014 og/eller 2015-2019. I tillegg er det noen territorier som er lagt inn i rovbase før dette og som vi ikke vet om er okkupert eller ikke i nyere tid. 


Hvor mange territorier ble overvåket i siste periode?
```{r}
table(dat$Visited_20)
```
Det er 533 territorier som ble overvåket i siste periode (egen farge i kartet over). Av disse var det kun 398 som var okkupert (pers. com. Jenny Mattison). 

```{r}
table(dat$Visit_2010, dat$Visited_20, deparse.level = 2)
```


Tabellen over sier oss at 635 territorier ikke har vært overvåket i noen av periodene (dvs de er registrer før 2010 og det er uvist om det er fugler der nå), og at 335 har vært overvåket i begge periodene.

Dette datasettet med 'teoretiske' territorier er nyttig for å visualisere på fordelingen av territorier i og innad i regioner og å regne på fordelingen mellom fjell og ikke-fjell. Det er ikke dette datasettet vi bruker for å si hvor mange territorier det er i dag. 
Modelleringer tilseier at det skal være rundt 1027 okkuperte territorier i Norge under siste perioden (2015-2019) (pers. com. Jenny Mattison). Disse dataene finnes på fylkesnivå og er hva vi må basere oss på som indikatormål. 



```{r}
tbl <- read_excel("data/kongeornterritorier_modellerte_perFylke.xlsx", 
     sheet = "tbl")
knitr::kable(tbl,
             caption = 
               "Tabell 1. Fylkesvis oversikt over antall estimerte okkuperte kongeørnterritorier (ekstensiv) samt okkupert intensivterritorier, og det totale antallet okkuperte territorier med øvre og nedre 95 % kredibilitetsintervaller. Data fra perioden 2010–2014 er hentet fra Dahl mfl. (2015).")
```

Vi trenger referansetilstander, enten for hele landsdeler,  regioner eller for fylker. Vi skal prøve å hente dette fra naturindeksen. Deretter trenger vi å kutee vekk Vestfold, Oslo, Østfold og Akershus. Der er det ingen kjente territorier (trolig mye underrapportering) som betyr at indikatoren ikke har gyldighet der. Det er også lite fjell i disse fylkene.

 

 





Etter diskusjon med Jenny er det klart at det ikke finnes godt nok grunnlag for å spesifisere egne referansetilstander for fjell og ikke-fjell (egentlig skog). Derfor er det ikke heller nødvendig å regne ut nøyaktig antall territorier, eller andel av territorieareal, som overlapper med fjell. Men vi gjør det her for å gi oss en oversikt.


Ett territorie er en sirkel med radius 10 km plassert rundt sentrumspunktet for de reirene som er inkludert i det samme territoriet (det kan være flere, men bare ett er okkupert til en hvert tid).



Lets also get a zoom box ready
```{r}
myExt <- raster::extent(100000, 300000, 6900000, 7100000)
```


```{r plotting}
plot(nor, axes=T)
plot(dat[,c('Terr_total', 'geometry')], add=T)
plot(myExt, add=T, lwd=10)


```

Det er ingenting på Østlandet. Ellers så er landet godt dekt. På Østlandet er det trolig stor underrapportering, siden vi vet det finnes mange territorier rett over grensa til Svergie, og habitatet er helt likt. Dette gjør det problematisk å sammenligne indiaktorverdie med referanseverdi på Østlandet. Kanskje må vi definere en 'underregion' av Østlandet (fjerne noen fylker) og sette ny referansetilstand.

Zoomer inn i ruta...
```{r}
datc <- sf::st_crop(dat, myExt)
plot(datc[,c('Terr_total', 'geometry')])

```

Det er som vi ser veldig mye overlapp mellom de teoretiske territoriene.



## Fjellmasken
Det neste vi må gjøre er å ekskludere territorier som ikke har fjell. Her har vi flere muligheter. La oss først ta inn fjellmasken.

```{r import fjell}
#fjell <- stars::read_stars("P:/41201042_okologisk_tilstand_fastlandsnorge_2020_dataanaly/FINAL/Raw_data/Ecosystems/ecoMap_50m.tif",
#                           proxy=F)

#fjell <- raster::raster("P:/41201042_okologisk_tilstand_fastlandsnorge_2020_dataanaly/FINAL/Raw_data/Ecosystems/ecoMap_50m.tif")
#fjell <- raster::raster("P:/41201042_okologisk_tilstand_fastlandsnorge_2020_dataanaly/M/Fjell/Mountain ecosystem Norge 50m.tif")
fjell <- raster::raster("/data/P-Prosjekter/41201042_okologisk_tilstand_fastlandsnorge_2020_dataanaly/M/Fjell/Mountain ecosystem Norge 50m.tif")

class(fjell)
```
Fila er ganske stor.


```{r}
dim(fjell)
```
32k * 32k gir litt over en milliard verdier (piksler)


```{r plotting fjell}
plot(fjell)
```
Denne masken ser ut til å være piksler med verdi 202 fra dette kartlaget:
P:\41201042_okologisk_tilstand_fastlandsnorge_2020_dataanaly\FINAL\Raw_data\Ecosystems\ecoMap_50m.tif

Fila er ganske tung å jobbe med så vi må prøve å redusere størrelsen
```{r}
summary(fjell)
```

Alle 0'er kan bli NA

```{r}
# fjellc <-  raster::mask(fjell, fjell[fjell==0],maskvalue = 0, updatevalue = NA)
```
Opperasjonen over tar for lang tid (ike ferdig på 2 timer)

Finner centroiden til territoriene for å defeinere de til skog eller fjell
```{r}
dat$centroid <- st_centroid(dat$geometry)
```

```{r plotting centroids}
# crop again
datc <- sf::st_crop(dat, myExt)
datc$centroid <- st_centroid(datc$geometry)

nor_sf <- st_as_sf(nor)
norc <- sf::st_crop(nor_sf, myExt)

fjellc <- raster::crop(fjell, myExt)

fjellc[fjellc[]==0] <- NA
fjellc[fjellc[]>0] <- 1


par(mfrow=c(1,1))
plot(norc$geometry, axes=T)
plot(fjellc, add=T)
plot(datc$geometry, add=T)
plot(datc$centroid, add=T)
```
Om vi skal bruke centroidene til å kategoriese territoriene som skog- eller fjellterritorier så må nok fjellmasken være på den oppløsningen den er. 
Men om vi skal istede regne ut andel av fjellpiksler per territorie så kan vi redusere oppløsningen betraktelig uten å miste informasjon.
Prøver først med centroidene:
```{r}
datc2 <- as(datc$centroid, 'Spatial') # extract-funksjonen krever spatial points dataframe
datc2$class <- raster::extract(fjellc, datc2, fun=sum, df=F)

plot(norc$geometry, axes=T)
  plot(fjellc, add=T)
  plot(datc2[!is.na(datc2$class),], add=T, pch=21)
  plot(datc2[is.na(datc2$class),], add=T)


```
Her vises centroidene som ligger i fjell som fylte sirkler, og de som ligger utenfor som plusstegn. De fleste ligger utenfor. Dette er bare et lite utsnitt av Norge, Men det kan være representatbelt da kongeørn ofte vil ha trær for å bygge reir, men de kan fortsatt jakte på fjellet. Jeg prøver derfor også den andre metoden. Først reduserer jeg oppløsningen på fjellmasken fra 50x50m til 1000x1000 (factor = 20).

```{r}
fjellc10 <- raster::aggregate(fjellc, fact = 20)
par(mfrow=c(1,2))
plot(fjellc); plot(fjellc10)
```
Noen av øyene ser ut til å ha blitt litt større. Kanskje vi kunne brukt fact = 10. La oss zoom inn litt til for å se.

```{r}
myExt2 <- raster::extent(200000, 300000, 6900000, 7000000)
fjellcc <- crop(fjellc, myExt2)
fjellc10c <- crop(fjellc10, myExt2)
par(mfrow=c(1,2))
plot(fjellcc); plot(fjellc10c)

```
Dette kan være en konsekvens av at jeg satta 0-verdier til NA, slik at alle aggregerte celler blir 1 gitt at det er >=1 fjellcelle der.

```{r}
fjellc[is.na(fjellc[])] <- 0
fjellc10v2 <- raster::aggregate(fjellc, fact = 20) # 5 sec. processing time
fjellccv2 <- crop(fjellc, myExt2)
fjellc10cv2 <- crop(fjellc10v2, myExt2)

# definerer nye fjellceller som de med fjellareal over 50%
fjellc10cv3 <- fjellc10cv2
fjellc10cv3[fjellc10cv3[]<0.5] <- 0
fjellc10cv3[fjellc10cv3[]>=0.5] <- 1

par(mfrow=c(2,2))
plot(fjellccv2, main="Original"); 
plot(fjellc10c, main = "With NA's instead of zeros"); 
plot(fjellc10cv2, main = "Aggregation with mean values"); 
plot(fjellc10cv3, main = "Aggregation with threshold")
```
Den siste ser grei ut. Plotter territoriene over masken for å sammenligne oppløsningen.

```{r}
datcc <- st_crop(datc, myExt2)
```
```{r}
plot(fjellc10cv3, main = "Aggregation with threshold")
  plot(datcc$geometry, add=T)

```



Ekstraktherer fraksjon fjellareal per polygon.
```{r}
datcc$andelFjell <- raster::extract(fjellc10cv3, datcc, fun = mean) # 9 sec processing time
```

```{r}
hist(datcc$andelFjell)
```
Territoriene har god spredning når det gjelder andel fjellareal

```{r}
myCols <- sf.colors(5, alpha = 0.5)
datcc$colour <- myCols[1]
datcc$colour[datcc$andelFjell >=0.2 & datcc$andelFjell < 0.4] <- myCols[2]
datcc$colour[datcc$andelFjell >=0.4 & datcc$andelFjell < 0.6] <- myCols[3]
datcc$colour[datcc$andelFjell >=0.6 & datcc$andelFjell < 0.8] <- myCols[4]
datcc$colour[datcc$andelFjell >=0.8]                          <- myCols[5]

plot(fjellc10cv3, main = "Aggregation with threshold", legend=F)
  plot(datcc$geometry, add=T, col = datcc$colour)
  legend("bottomright",   
      legend = c("<.2", ".2-.4", ".4-.6", ".6-.8", ">.8"), 
      fill = myCols)
  
```

Dette differensierer territoriene etter hvor mye fjell de innehar. Gjennomsnittet i dette utsnittet er `r mean(datcc$andelFjell)`.





## Sjekkliste
Sjekklisten er ikke utfylt enda.

![Sjekkliste](../output/test/abc.pdf){width=100%}

 Se endring
