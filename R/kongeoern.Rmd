---
title: "Kongeørn"
output:
  html_document:
    toc: true
    toc_depth: 3
    toc_float: true
    
knit: (function(input_file, encoding) {
  out_dir <- '../docs';
  rmarkdown::render(input_file,
 encoding=encoding,
 output_file=file.path(dirname(input_file), out_dir, 'kongeoern.html'))})
---

```{r setup, include=FALSE, message=FALSE}
library(knitr)
library(sf)
library(raster) # burde kanskje byttes ut med stars
library(sp)  # usikker på om jeg trenger denne
library(rgdal)
# library(stars) # vil ikke la seg installere på server
knitr::opts_chunk$set(echo = TRUE)
```


[Hjem](https://ninanor.github.io/IBECA) | 
[Økosystem Fjell](https://ninanor.github.io/IBECA/fjell)
![test](../figures/fjellLogo.png){width=1cm} |
[Økosystem Skog](https://ninanor.github.io/IBECA/skog)
![test](../figures/skogLogo.png){width=0.5cm} |
[Faktaark](https://ninanor.github.io/IBECA/faktaark) |


## Analyser av kongeørnterritorier
Datasettet ligger på P:// som er en server på NINA.


```{r import}
dat <- sf::st_read('P:/41201042_okologisk_tilstand_fastlandsnorge_2020_dataanaly/fjell2021/data/utbredelseKongeoern/Buff_10_All_terr_kongeørn.shp')
head(dat)
```
Datasettet inneholder alle kjente kongeørnterritorier i Norge (vi bryr oss ikke om streiffulger). Ikke alle territorier er okkupert til en hver tid. Det er to kolonner (`Visit_2021` og `Visit_20`) som indikarer hvorvidt territoriene har blitt overvåket i hhv 2010-2014 og/eller 2015-2019. Det er med andre ord data mellom 2010 og 2019. La oss se hvor mange territorier det er:

```{r}
length(unique(dat$Terr_total))
```
Er det noen duplikater?
```{r}
nrow(dat)
```
Nei, det er det ikke.

Hvor mange territorier ble overvåket i siste periode?
```{r}
table(dat$Visited_20)
```
Det er 533 territorier som ble overvåket i siste periode. Av disse var det kun 398 som var okkupert (pers. com. Jenny Mattison). Modelleringer tilseier at det skal være rundt 1027 okkuperte territorier i Norge under siste perioden (2015-2019) (pers. com. Jenny Mattison). Disse dataene finnes på fylkesnivå.  

```{r}
table(dat$Visit_2010, dat$Visited_20, deparse.level = 2)
```
Tabellen over sier oss at 635 territorier ikke har vært overvåket i noen av periodene (!?), og at 335 har vært overvåket i begge. 


Ett territorie er en sirkel med radius 10 km plassert rundt sentrumspunktet for de reirene som er inkludert i det samme territoriet (det kan være flere, men bare ett er okkupert til en hvert tid).

La oss se hvordan territoriene fordeler seg i landet. Først, las oss se hvilke crs dataene våre har og deretter laste inn en outline for Norge.

```{r crs}
crs(dat)
```




## Outline of Norway
```{r outline, eval=FALSE}
nor <- raster::getData('GADM', country='NOR', level=0)%>%
  sp::spTransform("+proj=utm +zone=33")
saveRDS(nor, '../data/norway_outline.RDS')
```

```{r, echo=FALSE}
nor <- readRDS('../data/norway_outline.RDS')
```

Lets also get a zoom box ready
```{r}
myExt <- raster::extent(100000, 300000, 6800000, 7000000)
```


```{r plotting}
plot(nor, axes=T)
plot(dat[,c('Terr_total', 'geometry')], add=T)
plot(myExt, add=T, lwd=10)


```
Det er ingenting på Østlandet. Ellers så er landet godt dekt.

Zoomer inn i ruta...
```{r}
datc <- sf::st_crop(dat, myExt)
plot(datc[,c('Terr_total', 'geometry')])

```
Det er som vi ser veldig mye overlapp mellom de teoretiske territoriene.



## Fjellmasken
Det neste vi må gjøre er å ekskludere territorier som ikke har fjell. Her har vi flere muligheter. La oss først ta inn fjellmasken.

```{r import fjell}
#fjell <- stars::read_stars("P:/41201042_okologisk_tilstand_fastlandsnorge_2020_dataanaly/FINAL/Raw_data/Ecosystems/ecoMap_50m.tif",
#                           proxy=F)

#fjell <- raster::raster("P:/41201042_okologisk_tilstand_fastlandsnorge_2020_dataanaly/FINAL/Raw_data/Ecosystems/ecoMap_50m.tif")
fjell <- raster::raster("P:/41201042_okologisk_tilstand_fastlandsnorge_2020_dataanaly/M/Fjell/Mountain ecosystem Norge 50m.tif")

class(fjell)
```
Fila erganske stor.


```{r}
dim(fjell)
```
32k * 32k gir litt over en milliard verdier (piksler)


```{r plotting fjell}
plot(fjell)
```
Denne masken ser ut til å være piksler med verdi 202 fra dette kartlaget:
P:\41201042_okologisk_tilstand_fastlandsnorge_2020_dataanaly\FINAL\Raw_data\Ecosystems\ecoMap_50m.tif

Fila er ganske tung å jobbe med så vi må prøve å redusere størrelsen
```{r}
summary(fjell)
```

Alle 0'er kan bli NA

```{r}
fjellc <-  raster::mask(fjell, fjell[fjell==0],maskvalue = 0, updatevalue = NA)
fjell[fjell[]==0] <- NA

```


Nå må vi fjerne territorier (sf-objects) som ikke har noe fjell (raster) i seg. Det er problematisk at territoriene er polygoner og masken er raster. En løsning er å gjøre polygonene om til raster (raster::rasterize), men da tror jeg vi mister for mye nyanser.  

```{r}
fjell2 <- st_as_sf(fjell)
joined <- intersect(dat, fjell)
joined <- st_intersection(dat, fjell)
```

## Sjekkliste
Sjekklisten er ikke utfylt enda.

![Sjekkliste](../output/test/abc.pdf){width=100%}


