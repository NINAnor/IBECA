---
title: "Rein"
output:
  html_document:
    toc: true
    toc_depth: 3
    toc_float: true
    
knit: (function(input_file, encoding) {
  out_dir <- '../docs';
  rmarkdown::render(input_file,
 encoding=encoding,
 output_file=file.path(dirname(input_file), out_dir, 'rein.html'))})
---

```{r setup, include=FALSE, message=FALSE}
library(knitr)
library(DT)
library(dplyr)
library(ggplot2)
library(readxl)
library(data.table)
library(readxl)
library(sf)
library(raster)
library(stars)
knitr::opts_chunk$set(echo = TRUE)
```

# Start
Dette er en felles indikator for villrein og tamreinsbestander
Utarbeidelsen av metodikken er gjort av Erik Fremstad.

# Import
Datasett med bestandstall, areal, og TRIverdier. Topographic roughenss index brukes til å modellere referansetilstand.
For hvert reinområde andgis areal per region. 

```{r}
dat <- read_excel("../data/rein.xlsx")
head(dat)
```

Kolonnen med total areal (helt til høyre) stemmer nesten med total fjellareal, så jeg kan bruke de vekselsvis.


```{r}
dat <- dplyr::select(dat, -navn2)
```

Så setter jeg alle NA til 0. Dette inkluderer totalbestand for Trollheimen. Trollheimen har tom celle for totalbestand. Siden det er skrevet 0 i cellen for fjellbestand så antar jeg det skal være null i den andre også.

```{r}
dat[is.na(dat)] <- 0
```

Regner ut fjellbestanden. Fjellbestanden regnes ut ved å anta at tettheten er lik i fjell og ikke-fjell.
```{r}
#dat$fjellbestand <- dat$bestand*(dat$fjellareal/dat$Totalreal)
```


Før jeg smelter datasettet vil jeg dele fjellbestanden mellom delarealene basert på fordeling av areal mellom regioner.
```{r}
dat$propN <- dat$N/dat$totalt
dat$propC <- dat$C/dat$totalt
dat$propE <- dat$E/dat$totalt
dat$propW <- dat$W/dat$totalt
dat$propS <- dat$S/dat$totalt
```



# Melt
Nå deler jeg opp villreinområdene i så mange regioner som de inngår i

```{r}
setDT(dat)
dat2 <- melt(dat,
             measure.vars = c("N", "C", "E", "W", "S"),
             value.name = "area",
             variable.name= "reg",
             na.rm=T)
```

Dette gir fem rader per område. Så tar jeg bort de radene der det ikke finnes noe (fjell)areal
```{r}
temp <- dat2[dat2$type=="ingen rein",]
dat2 <- dat2[dat2$area>0,]
dat2 <- rbind(dat2, temp)
rm(temp)
```


Så kan jeg regne ut referansetettheter.
Her er referanseverdier for tetthet gitt som 75% av bestandsmål. Metoden er beskrevet andre steder, men baseres seg på sammenhengen mellom topgrafisk varisjon og bestandsmålene for villrein. 
```{r}
dat2$ref <- 0.75*1.0759*exp(-0.001*dat2$`TRI-fjell`)
```

Lager noen alternativer
```{r}
dat2$ref60 <- 0.60*1.0759*exp(-0.001*dat2$`TRI-fjell`)
dat2$ref80 <- 0.80*1.0759*exp(-0.001*dat2$`TRI-fjell`)
```


```{r}
temp <- dat2[dat2$type=="ingen rein",]
dat2 <- dat2[dat2$type!="ingen rein",]
```

```{r}
temp2 <- temp[temp$navn == "Fjell uten rein - nord" &
                temp$reg %in% c("N"),]

temp3 <- temp[temp$navn == "Fjell uten rein - sør" &
                temp$reg %in% c("E", "S", "W", "C"),]

temp4 <- temp[temp$navn =="Fjellområder uten rein",]
temp4 <- temp4[!duplicated(temp4$reg)]

temp <- rbind(temp2, temp3)
temp$area <- temp4$area[match(temp$reg, temp4$reg)]
```

```{r}
dat2 <- rbind(dat2, temp)
```


Og de observerte tetthetene. Siden tettheten er antat lik i fjell og ikke-fjell trenger vi ikke gå veien innom å regne ut bestandstall
```{r}
dat2$tetthet <- dat2$bestand/dat2$Totalreal
dat2$tetthet[dat2$type=="ingen rein"] <- 0
```

```{r}
df <- data.table(reg = unique(dat2$reg),
                 obs = as.numeric(),
                 ref = as.numeric())
for(i in unique(dat2$reg)){
  
  
  temp <- dat2[dat2$reg ==i,]
  
  df[df$reg==i, "obs"] <- weighted.mean(temp$tetthet, temp$area)
  df[df$reg==i, "ref"] <- weighted.mean(temp$ref, temp$area)
}
```

```{r}
df$diff <- df$ref-df$obs
df
```

Vi har både positive og negative tall her, så vi trenger kanskje en tosidig indikator. Men samtidig, den positive verdien på vestlandet er veldig liten.


Nei, jeg må gjøre dette anderledes og skalere per delområde!
