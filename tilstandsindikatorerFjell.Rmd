---
title: "Økosystem Fjell"

output:
  html_document:
    toc: true
    toc_depth: 6
    toc_float: true
    
    
knit: (function(input_file, encoding) {
  out_dir <- 'docs';
  rmarkdown::render(input_file,
 encoding=encoding,
 output_file=file.path(dirname(input_file), out_dir, 'fjell.html'))})
 
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```




[Hjem](https://ninanor.github.io/IBECA) | 
[Økosystem Fjell](https://ninanor.github.io/IBECA/fjell)
![test](figures/fjellLogo.png){width=1cm} |
[Økosystem Skog](https://ninanor.github.io/IBECA/skog)
![test](figures/skogLogo.png){width=0.5cm} |
[Faktaark](https://ninanor.github.io/IBECA/faktaark) |


### Indikatorenes tilknyttning til påvirkninger og egenskaper

Denne figurene er kun et 'proof of consept', men skal vise hvordan tilstandsikatorene knytter seg til de ulike påvirkningene og egenskapene. Nodene er klikkbare og tar deg til faktaarket. Hold musepeker over boksene får å se noe utfyllende informasjon, og klikk for se enda mer detaljer.


```{r, echo=F, message=FALSE}
library(readxl)
library(DiagrammeR)
library(dplyr)

ind <- read_excel("data/indData.xlsx", 
                  sheet = "tilstandsindikatorer")

paa <- read_excel("data/indData.xlsx", 
                  sheet = "paavirkninger")

ege <- read_excel("data/indData.xlsx", 
                  sheet = "egenskaper")

dat <- read_excel("data/indData.xlsx", 
                  sheet = "datasett")



# Import edges ------------------------------------------------------------

edges <- read_excel("data/indData.xlsx", 
                    sheet = "relasjoner")

#names(edges)
fakeEdge <- data.frame(ID = "",
                       from = c("Fremmede arter", "spacenode", 
                                "Bestandsnivå villrein", "spacenode2"),
                       to = c("spacenode","Bestandsnivå villrein", 
                              "spacenode2", "Funksjonelt viktige arter og strukturer"),
                       tooltip = "",
                       beskrivelse = "",
                       kategori = "space-cat",
                       referanser = "")

edges <- rbind(edges, fakeEdge)


# combine nodes
nodes <- data.frame(nodes = c(ind$node,
                              paa$node,
                              ege$node,
                              dat$datasettnavn),
                    tooltip = c(ind$tooltip,
                                paa$tooltip,
                                ege$tooltip,
                                dat$dataeier),
                    type = rep(c("ind", "paa", "ege", "dat"), 
                               times=c(nrow(ind),
                                       nrow(paa),
                                       nrow(ege),
                                       nrow(dat))))  # har kan vi også legge til en kolonne for tooltips etc




# add space-nodes ---------------------------------------------------------

#colnames(nodes)
space <- data.frame(nodes = c("spacenode", "spacenode2"),
                    tooltip= c("", ""),
                    type = c("space", "space2"))
nodes <- rbind(nodes, space)








# subsett -----------------------------------------------------------------


nodes2 <- nodes[nodes$type!="dat",]
edges2 <- edges[edges$kategori!="dat-ind",]

row.names(nodes2) <- seq(1:nrow(nodes2))


indID <- row.names(nodes2)[nodes2$type=="ind"]
paaID <- row.names(nodes2)[nodes2$type=="paa"]
egeID <- row.names(nodes2)[nodes2$type=="ege"]
datID <- row.names(nodes2)[nodes2$type=="dat"]
spaceID <- row.names(nodes2)[nodes2$type=="space"]
space2ID <- row.names(nodes2)[nodes2$type=="space2"]

#table(edges2$from %in% nodes2$nodes)
#table(edges2$to %in% nodes2$nodes)
# all edges to's and from's are identical to node names

# the dag craches if there's a column called tooltip
edges2 <- rename(edges2, tooltip_edge = tooltip)


# Add unique URLs

nodes2$URL <- "https://ninanor.github.io/IBECA/faktaark"
nodes2$URL[nodes2$nodes== "Bestandsnivå fjellrev"] <- "https://ninanor.github.io/IBECA/faktaark#bestandsnivå-fjellrev"
nodes2$URL[nodes2$nodes== "Bestandsnivå jerv"] <- "https://ninanor.github.io/IBECA/faktaark#bestandsnivå-jerv"


# DAG ---------------------------------------------------------------------


dag <- create_graph( 
  attr_theme = "lr"
) %>%   
  
  add_nodes_from_table(
    table = nodes2,
    type_col = type,
    label_col = nodes
  ) %>%
  
  # global styling of nodes
  set_node_attrs(node_attr = shape, values =  "box") %>%
  set_node_attrs(node_attr = shape, values =  "triangle", nodes = paaID) %>%
  
  set_node_attrs(node_attr = URL, values =  nodes2$URL) %>%
  
  set_node_attrs(node_attr = rank, values =  1, nodes = paaID) %>%
  set_node_attrs(node_attr = rank, values =  3, nodes = indID) %>%
  set_node_attrs(node_attr = rank, values =  5, nodes = egeID) %>%
  set_node_attrs(node_attr = rank, values =  2, nodes = spaceID) %>%
  set_node_attrs(node_attr = rank, values =  4, nodes = space2ID) %>%
  
  set_node_attrs(node_attr = fontcolor, values =  "black", nodes = paaID) %>%
  set_node_attrs(node_attr = fontcolor, values =  "white", nodes = indID) %>%
  set_node_attrs(node_attr = fontcolor, values =  "white", nodes = egeID) %>%
  
  set_node_attrs(node_attr = tooltip, values =  nodes2$tooltip) %>%
  
  set_node_attrs(node_attr = width, values =  3.1, nodes = egeID) %>%  # width of egenskaper
  set_node_attrs(node_attr = width, values =  1.5, nodes = indID) %>% 
  set_node_attrs(node_attr = width, values =  1.5, nodes = spaceID) %>% 
  set_node_attrs(node_attr = width, values =  1.5, nodes = space2ID) %>% 
  set_node_attrs(node_attr = width, values =  1.5, nodes = paaID) %>% 
  set_node_attrs(node_attr = height, values =  1.5, nodes = paaID) %>% 
  
  set_node_attrs(node_attr = penwidth, value = 4) %>%
  
  set_node_attrs(node_attr = style, values =  'invisible', nodes = spaceID) %>%
  set_node_attrs(node_attr = style, values =  'invisible', nodes = space2ID) %>%
  
  
  
  
  # edges
  add_edges_from_table(
    table = edges2,
    rel_col = kategori,
    from_col = from,
    to_col = to,
    from_to_map = label    
  )  %>%
  
 # select_edges(conditions = rel == "A") %>%
 # rev_edge_dir_ws() %>%
 # clear_selection() %>%
  
  
  # edge colour
  set_edge_attrs(edge_attr = color, values = "black") %>%
  set_edge_attrs(edge_attr = penwidth, values = 3) %>%
  set_edge_attrs(edge_attr = headport, values = "w") %>%
  
  
  # colouring the nodes
  select_nodes(conditions = type == "ind") %>%
  set_node_attrs_ws(node_attr = fillcolor, value = "DarkOliveGreen") %>%
  clear_selection()%>%
  
  select_nodes(conditions = type == "paa") %>%
  set_node_attrs_ws(node_attr = fillcolor, value = "Goldenrod") %>%
  clear_selection() %>%
  
  select_nodes(conditions = type == "ege") %>%
  set_node_attrs_ws(node_attr = fillcolor, value = "grey40") %>%
  clear_selection()
  


render_graph(dag, width = 800, height = 1600)
```





