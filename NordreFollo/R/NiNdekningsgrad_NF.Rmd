---
title: "Naturtyper etter Miljødirektoratetsinnstruks - dekkningsdrad i Nordre Follo"
output:
  html_document:
    toc: true
    toc_depth: 3
    toc_float: true
    
knit: (function(input_file, encoding) {
  out_dir <- '../../docs';
  rmarkdown::render(input_file,
 encoding=encoding,
 output_file=file.path(dirname(input_file), out_dir, 'NiNdekkningsgrad.html'))})
---


```{r setup, include=FALSE, message=FALSE}
library(knitr)
library(dplyr)
library(ggplot2)
library(raster)
library(rgdal)
library(tmap)
library(sf)
knitr::opts_chunk$set(echo = TRUE)
```




Imoport Naturtyper dataset (exported from Naturbase 20 dec 2021)
```{r}
dat <- readOGR(dsn = "../data/Natur_Naturtyper_NiN_3020_nordre_follo_25833.gdb")
dat2 <- sf::st_as_sf(dat)
names(dat2)[3] <- "Hovedøkosystem"
```


```{r}
unique(dat2$Hovedøkosystem)
dat2$Hovedøkosystem[dat2$Hovedøkosystem=="Naturlig Ã¥pne omrÃ¥der i lavlandet"] <- "Naturlig åpne områder"
dat2$Hovedøkosystem[dat2$Hovedøkosystem=="VÃ¥tmark"] <- "Våtmark"
```

```{r}
unique(dat2$tilstand)
dat2$tilstand[dat2$tilstand == "SvÃ¦rt redusert"] <- "Svært redusert"
dat2$tilstand[dat2$tilstand == "DÃ¥rlig"] <- "Dårlig"
```


Import outlines of municipalities and make a cropped version as well which is smaller and easier to work with
```{r}
kom <- sf::st_read("R:/GeoSpatialData/AdministrativeUnits/Norway_AdministrativeUnits/Converted/Norway_Municipalities/Kommune_polygon_2020.shp")
kom_crop <- st_crop(kom, dat2)

```

Instrad of cropping, we can single out Nordre Follo
```{r}
nf <- kom[kom$NAVN== "Nordre Follo",]
```

Reorder factor levels
```{r}
unique(dat2$tilstand)
dat2$tilstand <- factor(dat2$tilstand, levels = c("Svært redusert", "Dårlig","Moderat", "God"))
```


## Summarise the number of localities per hovedøkosystem and condition
```{r}
dat3 <- as.data.frame(table(dat2$tilstand, dat2$Hovedøkosystem))
names(dat3) <- c("Tilstand", "Hovedøkosystem", "Freq")
```

```{r, fig.width=7, fig.height=7}
ggplot(data = dat3)+
  geom_bar(aes(y = Freq, x = Hovedøkosystem, group=Tilstand, fill=Tilstand),
           stat = "identity", position="dodge")+
  theme_bw(base_size = 20)+
  xlab("")+
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))+
  ylab("Antall lokaliteter")
```

## Plot map of Nordre Follo with localities coloured by hovedøkosystem
First fix bbox
```{r}
bbox_new <- st_bbox(nf)

xrange <- bbox_new$xmax - bbox_new$xmin # range of x values
yrange <- bbox_new$ymax - bbox_new$ymin # range of y values

#increase ymax 10%
bbox_new[4] <- bbox_new[4] + (0.1 * yrange) 

```


```{r, fig.width=5, fig.height=7}
tm_shape(nf, bbox = bbox_new)+
  tm_polygons()+
  tm_shape(dat2)+
  tm_polygons(col = "Hovedøkosystem")+
   tm_layout(
    legend.position = c("left", "bottom"), 
    title= 'Naturtyper etter Miljødirektoratets instruks\ni Nordre Follo kommune, anno desember 2021', 
    title.position = c('right', 'top'))
```






Calculate the rea of each polygon (Naturtyper and municipality)
```{r}
dat2$area <- st_area(dat2)
#kom_crop$area <- st_area(kom_crop)
nf$area <- st_area(nf)
```

The area of Nordre Follo in km2 is
```{r}
tot <- round(as.numeric(nf$area/1000000),2)
tot
```
[Wikipedia](https://no.wikipedia.org/wiki/Nordre_Follo) says it's 203 km2, but that's fairly close.

##Calculate Naturtype area for each hovedøkosystem
```{r}
dat4 <- aggregate(data = dat2,
                  area~Hovedøkosystem,
                  FUN = sum)

# convert to km2
dat4$area2 <- as.numeric(dat4$area/1000000)
```

```{r, fig.width=7, fig.height=7}
ggplot(data = dat4)+
  geom_bar(aes(x = Hovedøkosystem, y = area2),
           stat = "identity",
           fill = "grey", colour="black")+
  theme_bw(base_size = 20)+
  xlab("")+
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))+
  ylab("Summert areal km-2")
```

Let's make the same figure, but as a stacked barplot conditioned on locality condition
```{r}
# convert to km2
dat2$area3 <- as.numeric(dat2$area)/1000000
```


```{r, fig.width=7, fig.height=7}
(areal <- ggplot(data = dat2)+
  geom_bar(aes(x = Hovedøkosystem, 
               y = area3,
               group = tilstand,
               fill = tilstand),
           stat = "sum")+
  theme_bw(base_size = 20)+
  xlab("")+
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))+
  ylab("Areal km-2")+
   theme(legend.position = "none")
)

```

```{r, fig.width=7, fig.height=7}
(antall <- ggplot(data = dat3)+
  geom_bar(aes(y = Freq, 
               x = Hovedøkosystem, 
               group=Tilstand, 
               fill=Tilstand),
           stat = "identity")+
  theme_bw(base_size = 20)+
  xlab("")+
  theme(axis.text.x = element_blank())+
  ylab("Antall lokaliteter")+
   theme(legend.position=c(0.2,0.7))
)
```




```{r, fig.height=12, fig.width=7, eval=F}
png("../output/Naturtypelokaliteter etter tilstand.png", width = 500, height = 1000, units = "px")
ggpubr::ggarrange(
  antall, 
  areal,
ncol=1,nrow=2)
dev.off()
```
The information can be put into a table like this
```{r}
dat5 <- aggregate(data = dat2,
                  area~Hovedøkosystem+tilstand,
                  FUN = sum,
                  drop = F)

dat5$area <- as.numeric(dat5$area/1000000)
dat5$area[is.na(dat5$area)] <- 0
dat5$area <- round(dat5$area, 4)
dat6 <- data.table::dcast(data = dat5,
                          Hovedøkosystem~tilstand)
dat7 <- ggpubr::ggtexttable(dat6, rows = NULL)
dat7
```

We could add this table to the ggarrange plot along with a caption
```{r, fig.height=1, fig.width=3}
text <- paste("Tabell: Areal (km-2) utfigurerte naturtyper etter Miljødireltoratets instruks i Nordre Follo kommune.", sep = " ")
text.p <- ggpubr::ggparagraph(text = text, face = "italic", size = 11, color = "black")
text.p
```

Or perhaps just as a png output by itself.
```{r, fig.height=3, fig.width=5, eval=F}
png("../output/Areal naturtyper etter tilstand.png", width = 400, height = 200, units = "px")
ggpubr::ggarrange(text.p, 
  dat7,
ncol=1,nrow=4,
heights = c(0.2,0.1))
dev.off()
```



# Dekningskart

